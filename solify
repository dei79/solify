#!/bin/bash

# install the default version of ruby which comes together with the distribution. This is enough for
# setting up the machine. A better version will be installed later with the help of rbenv
echo "Installing system packages"
sudo apt-get -y install git-core ruby > /dev/null

# install a chef-solo and his helpers
if [ -z `which librarian-chef` ]; then
    echo "Installing librarian-chef"
    sudo gem install librarian --no-ri --no-rdoc > /dev/null
fi

if [ -z `which chef-solo` ]; then
    echo "Installing chef-solo"
    sudo gem install chef ruby-shadow --no-ri --no-rdoc > /dev/null
fi


# visit the chef directory
cd chef

# download the external cookbooks
echo "Installing or updating external cookbooks"
sudo librarian-chef install

# do some special fixes before we can start chef-solo
echo "Fixing file system"
[ -e /etc/chef/ohai_plugins/README ] && sudo rm -f /etc/chef/ohai_plugins/README

# execute chef-solo
echo "Running chef-solo"
sudo chef-solo -c solo.rb

# go up
cd ..
